/* PROJECT LICENSE */

import apiService, { listen } from '../../src/server';
import request from 'supertest';
import mysql from 'mysql2/promise';
import { cleanDatabase } from './util/cleandatabase.utils';
import User from '../../src/modules/users/models/User';
import { testUtilCreateUser } from './util/createuser.util';
import Course from '../../src/modules/courses/models/Course';
import { testUtilCreateCourse } from './util/createcouse.util';
import Module from '../../src/modules/modules/models/Module';
import { testUtilCreateModule } from './util/createmodule.util';
import Lesson from '../../src/modules/lessons/models/Lesson';
import { testUtilCreateLesson } from './util/createlesson.util';
import { Server } from 'http';

let storageConnection: mysql.Connection;
let server: Server;
beforeAll(async () => {
  server = await listen();
  storageConnection = await mysql.createConnection({
    host: 'localhost',
    user: 'test',
    password: 'test',
    database: 'LEARNING_MANAGEMENT_SYSTEM',
  });
});
afterAll(async () => {
  await storageConnection.end();
  return new Promise<void>((resolve, reject) => {
    server.close((err) => {
      if (err) {
        return reject(err);
      }
      return resolve();
    });
  })
});

describe('IT | Modules', () => {
  let user: User;
  let course: Course;
  let module: Module;
  beforeEach(async () => {
    user = await testUtilCreateUser(storageConnection);
    course = await testUtilCreateCourse(storageConnection, "My course");
  });
  describe('POST /v1/users/:userId/courses/:courseId/modules', () => {
    afterEach(async () => {
      await cleanDatabase(storageConnection);
    });
    it('should create a module', async () => {
      const PATH = '/v1/users/' + user.id + '/courses/' + course.id + '/modules';
      const TITLE = 'My first module';
      const response = await request(apiService).post(PATH).send({
        title: TITLE,
      });
      expect(response.status).toBe(201);
      expect(typeof response.body.id).toBe('string');
      expect(response.body).toEqual({
        id: response.body.id,
        course_id: course.id,
        title: TITLE,
        is_root_module: true,
        module_id: undefined,
      });
    });
  });
  describe('GET /v1/users/:userId/courses/:courseId/modules/:moduleId', () => {
    let firstLesson: Lesson;
    let secondLesson: Lesson;
    let innerModule: Module;
    beforeEach(async () => {
      module = await testUtilCreateModule(storageConnection, "1.1 My first module", course.id!);
      innerModule = await testUtilCreateModule(storageConnection, "1.1.1 My inner module", course.id!, module.id!);
      firstLesson = await testUtilCreateLesson(storageConnection, "1.1 My lesson", module.id!);
      secondLesson = await testUtilCreateLesson(storageConnection, "1.2 My second lesson", module.id!);
    });
    afterEach(async () => {
      await cleanDatabase(storageConnection);
    });
    it('should retrieve a module', async () => {
      const PATH = '/v1/users/' + user.id + '/courses/' + course.id + '/modules/' + module.id;
      const response = await request(apiService).get(PATH);

      expect(response.status).toBe(200);
      expect(response.body).toEqual({
        id: module.id,
        course_id: module.courseId,
        title: module.title,
        is_root_module: module.isRootModule,
        module_id: module.moduleId,
        lessons: [{
          id: firstLesson.id,
          title: firstLesson.title,
          module_id: firstLesson.moduleId,
          is_completed: false,
        }, {
          id: secondLesson.id,
          title: secondLesson.title,
          module_id: secondLesson.moduleId,
          is_completed: false,
        }],
        modules: [{
          id: innerModule.id,
          course_id: course.id,
          title: innerModule.title,
          is_root_module: innerModule.isRootModule,
          module_id: innerModule.moduleId,
          lessons: [],
          modules: [],
        }]
      });
    });
    it('should cache responses', async () => {
      const PATH = '/v1/users/' + user.id + '/courses/' + course.id + '/modules/' + module.id;

      const uncachedResponseStart = performance.now();
      await request(apiService).get(PATH);
      const uncachedResponseEnd = performance.now();

      const cachedResponseStart = performance.now();
      await request(apiService).get(PATH);
      const cachedResponseEnd = performance.now();

      const uncachedResponseMs = uncachedResponseEnd - uncachedResponseStart;
      const cachedResponseMs = cachedResponseEnd - cachedResponseStart;

      expect(uncachedResponseMs)
        .toBeGreaterThan(cachedResponseMs);
    });
  });
  describe('GET /v1/users/:userId/courses/:courseId/modules/', () => {
    let firstLesson: Lesson;
    let secondLesson: Lesson;
    let innerModule: Module;
    let secondModule: Module;
    beforeEach(async () => {
      module = await testUtilCreateModule(storageConnection, "1.1 My first module", course.id!);
      innerModule = await testUtilCreateModule(storageConnection, "1.1.1 My inner module", course.id!, module.id!);
      firstLesson = await testUtilCreateLesson(storageConnection, "1.1 My lesson", module.id!);
      secondLesson = await testUtilCreateLesson(storageConnection, "1.2 My second lesson", module.id!);
      secondModule = await testUtilCreateModule(storageConnection, "1.2 My second module", course.id!);
    });
    afterEach(async () => {
      await cleanDatabase(storageConnection);
    });
    it('should retrieve a list of modules', async () => {
      const PATH = '/v1/users/' + user.id + '/courses/' + course.id + '/modules/?limit=10&offset=0';
      const response = await request(apiService).get(PATH);

      expect(response.status).toBe(200);
      expect(response.body).toEqual([{
        id: module.id,
        course_id: module.courseId,
        title: module.title,
        is_root_module: module.isRootModule,
        module_id: module.moduleId,
        lessons: [{
          id: firstLesson.id,
          title: firstLesson.title,
          module_id: firstLesson.moduleId,
          is_completed: false,
        }, {
          id: secondLesson.id,
          title: secondLesson.title,
          module_id: secondLesson.moduleId,
          is_completed: false,
        }],
        modules: [{
          id: innerModule.id,
          course_id: course.id,
          title: innerModule.title,
          is_root_module: innerModule.isRootModule,
          module_id: innerModule.moduleId,
          lessons: [],
          modules: [],
        }]
      }, {
        id: secondModule.id,
        course_id: secondModule.courseId,
        title: secondModule.title,
        is_root_module: secondModule.isRootModule,
        module_id: secondModule.moduleId,
        lessons: [],
        modules: []
      }]);
    });
  });
});

